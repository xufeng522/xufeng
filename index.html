<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ°´å¢¨åŠ¨ç‰©æ¶ˆæ¶ˆä¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .game-container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid #e0e0e0;
        }

        /* å¾—åˆ†æ æ ·å¼ */
        .score-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 15px;
            color: white;
            flex-wrap: wrap;
            gap: 10px;
            border: 2px solid #1a252f;
        }

        .score-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .current-score, .best-score {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .label {
            font-weight: bold;
            opacity: 0.9;
        }

        .value {
            font-size: 16px;
            font-weight: bold;
            color: #f1c40f;
        }

        .next-pieces {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .next-pieces-container {
            display: flex;
            gap: 5px;
        }

        .next-piece {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        .restart-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            border: 2px solid #c0392b;
        }

        .restart-btn:hover, .restart-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        /* æ¸¸æˆæ£‹ç›˜æ ·å¼ - é»‘ç™½æ°´å¢¨é£æ ¼ */
        .game-board {
            display: grid;
            gap: 2px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 3px solid #000;
        }

        .game-board.size-9 {
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
        }

        .game-board.size-8 {
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
        }

        .cell {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid #d0d0d0;
        }

        .cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .cell.selected {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
            border: 2px solid #2980b9;
        }

        .cell.valid-move {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            animation: pulse 1s infinite;
            border: 2px solid #27ae60;
        }

        .cell.path {
            background: #b3c6e0cc; /* æ·¡è“è‰²ï¼Œå¸¦é€æ˜åº¦ */
            border: 2px solid #5d6d7e;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* æ£‹å­æ ·å¼ - é»‘ç™½æ°´å¢¨é£æ ¼ */
        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            transition: all 0.3s ease;
            position: relative;
            border: 3px solid rgba(0, 0, 0, 0.3);
        }

        .piece.eliminating {
            animation: eliminate 0.5s ease-out;
        }

        @keyframes eliminate {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* åŠ¨ç‰©æ£‹å­é¢œè‰² - é»‘ç™½æ°´å¢¨é£æ ¼ */
        .piece[data-type="tiger"] {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-color: #1a252f;
        }

        .piece[data-type="dragon"] {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-color: #000;
        }

        .piece[data-type="phoenix"] {
            background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
            border-color: #5d6d7e;
        }

        .piece[data-type="turtle"] {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border-color: #1a252f;
        }

        .piece[data-type="crane"] {
            background: linear-gradient(135deg, #5d6d7e 0%, #7f8c8d 100%);
            border-color: #34495e;
        }

        .piece[data-type="panda"] {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            border-color: #5d6d7e;
        }



        .difficulty-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .difficulty-selector label {
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        .difficulty-select {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .difficulty-select:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .difficulty-select option {
            background: #2c3e50;
            color: white;
        }

        /* ç¤¼èŠ±æ•ˆæœ */
        .firework {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            animation: firework 2s ease-out forwards;
        }

        @keyframes firework {
            0% {
                transform: scale(0);
                opacity: 1;
                background: #ff6b6b;
            }
            50% {
                transform: scale(1);
                opacity: 1;
                background: #4ecdc4;
            }
            100% {
                transform: scale(0);
                opacity: 0;
                background: #45b7d1;
            }
        }

        /* ç­‰çº§æ˜¾ç¤ºæ ·å¼ */
        .level-display {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .level-badge {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }

        /* æ§åˆ¶è¡Œæ ·å¼ */
        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-row .level-display {
            margin: 0;
        }

        .control-row .difficulty-selector {
            margin: 0;
        }

        .control-row .restart-btn {
            margin: 0;
        }

        /* æ¸¸æˆç»“æŸæ¨¡æ€æ¡† */
        .game-over-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 300px;
            width: 90%;
            border: 3px solid #2c3e50;
        }

        .modal-content h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .modal-content p {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 16px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .game-container {
                padding: 15px;
                margin: 10px;
            }

            .score-panel {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .score-info {
                flex-direction: row;
                justify-content: space-between;
            }

            .next-pieces {
                justify-content: center;
            }

            .game-board {
                gap: 1px;
                padding: 8px;
            }

            .cell {
                border-radius: 6px;
            }

            .piece {
                font-size: 16px;
            }
        }

        /* æ°´å¢¨é£æ ¼è£…é¥° */
        .game-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, transparent 30%, rgba(0, 0, 0, 0.1) 50%, transparent 70%);
            border-radius: 25px;
            z-index: -1;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* éŸ³æ•ˆæ§åˆ¶ */
        .sound-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            font-size: 20px;
        }

        .sound-control:hover {
            background: rgba(0, 0, 0, 0.9);
        } 

        .bgm-control {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            font-size: 22px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: background 0.2s;
        }
        .bgm-control:hover {
            background: rgba(0, 0, 0, 0.9);
        } 
    </style>
</head>
<body>
    <!-- èƒŒæ™¯éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <button class="bgm-control" id="bgmControl">ğŸ”Š</button>
    <!-- èƒŒæ™¯éŸ³ä¹ï¼ˆä¸­å›½é£BGMï¼Œç¤ºä¾‹ç”¨ç½‘ç»œå¯ç”¨çš„å…è´¹BGMï¼‰ -->
    <audio id="bgm" loop preload="auto">
        <source src="https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b8b6b2.mp3" type="audio/mp3">
    </audio>
    <!-- éŸ³æ•ˆæ§åˆ¶æŒ‰é’®ï¼ˆä»…ä¿ç•™æ¶ˆé™¤éŸ³æ•ˆï¼Œä¸å†æ§åˆ¶ï¼‰ -->
    <button class="sound-control" id="soundControl" style="display:none">ğŸ”Š</button>
    
    <div class="game-container" id="gameContainer">
        <!-- å¾—åˆ†æ  -->
        <div class="score-panel">
            <div class="score-info">
                <div class="current-score">
                    <span class="label">å¾—åˆ†:</span>
                    <span class="value" id="currentScore">0</span>
                </div>
                <div class="best-score">
                    <span class="label">å†å²è®°å½•:</span>
                    <span class="value" id="bestScore">0</span>
                </div>
            </div>
            
            <!-- é¢„ç”Ÿæˆæ£‹å­ -->
            <div class="next-pieces">
                <span class="label">ä¸‹æ¬¡æŠ•æ”¾:</span>
                <div class="next-pieces-container" id="nextPieces">
                    <div class="next-piece" data-type=""></div>
                    <div class="next-piece" data-type=""></div>
                    <div class="next-piece" data-type=""></div>
                </div>
            </div>
            
            <div class="control-row">
                <div class="level-display">
                    <span class="label">ç­‰çº§:</span>
                    <span class="level-badge" id="levelDisplay">é’é“œ</span>
                </div>
                <div class="difficulty-selector">
                    <label for="difficultySelect">éš¾åº¦:</label>
                    <select id="difficultySelect" class="difficulty-select">
                        <option value="normal">æ­£å¸¸</option>
                        <option value="medium">ä¸­ç­‰</option>
                        <option value="hard">å›°éš¾</option>
                    </select>
                </div>
                <button class="restart-btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
        
        <!-- æ¸¸æˆæ£‹ç›˜ -->
        <div class="game-board" id="gameBoard">
            <!-- 9x9æ£‹ç›˜æ ¼å­å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- æ¸¸æˆç»“æŸæç¤º -->
        <div class="game-over-modal" id="gameOverModal">
            <div class="modal-content">
                <h2>æ¸¸æˆç»“æŸ</h2>
                <p>æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></p>
                <button class="restart-btn" id="modalRestartBtn">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>
    
    <!-- éŸ³æ•ˆæ–‡ä»¶ -->
    <audio id="eliminateSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>
    <audio id="moveSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>
    <audio id="selectSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>
    
    <script>
        class AnimalMatchGame {
            constructor(difficulty = 'normal') {
                this.difficulty = difficulty;
                this.setDifficulty(difficulty);
                this.board = [];
                this.currentScore = 0;
                this.bestScore = localStorage.getItem('bestScore') || 0;
                this.nextPieces = [];
                this.selectedCell = null;
                this.gameOver = false;
                this.soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
                
                // ç­‰çº§ç³»ç»Ÿ
                this.playerLevel = this.getPlayerLevel();
                this.currentLevel = this.calculateLevel(this.currentScore);
                
                // åŠ è½½æ¸¸æˆçŠ¶æ€
                this.loadGameState();
                
                this.init();
            }
            
            // è®¡ç®—ç©å®¶ç­‰çº§
            calculateLevel(score) {
                if (score <= 3000) return 'é’é“œ';
                if (score <= 5000) return 'é»„é‡‘';
                if (score <= 7000) return 'é“‚é‡‘';
                if (score <= 12000) return 'é’»çŸ³';
                if (score <= 16000) return 'æ˜Ÿè€€';
                return 'ç‹è€…';
            }
            
            // è·å–ç©å®¶æœ€é«˜ç­‰çº§
            getPlayerLevel() {
                const savedLevel = localStorage.getItem('playerLevel') || 'é’é“œ';
                return savedLevel;
            }
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            saveGameState() {
                const gameState = {
                    board: this.board,
                    currentScore: this.currentScore,
                    nextPieces: this.nextPieces,
                    difficulty: this.difficulty,
                    gameOver: this.gameOver
                };
                localStorage.setItem('gameState', JSON.stringify(gameState));
            }
            
            // åŠ è½½æ¸¸æˆçŠ¶æ€
            loadGameState() {
                const savedState = localStorage.getItem('gameState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        // åªæœ‰å½“éš¾åº¦ç›¸åŒæ—¶æ‰åŠ è½½çŠ¶æ€
                        if (state.difficulty === this.difficulty && !state.gameOver) {
                            this.board = state.board;
                            this.currentScore = state.currentScore;
                            this.nextPieces = state.nextPieces;
                            this.gameOver = state.gameOver;
                            return true;
                        }
                    } catch (e) {
                        console.log('åŠ è½½æ¸¸æˆçŠ¶æ€å¤±è´¥:', e);
                    }
                }
                return false;
            }
            
            // æ¸…é™¤æ¸¸æˆçŠ¶æ€
            clearGameState() {
                localStorage.removeItem('gameState');
            }
            
            setDifficulty(difficulty) {
                switch(difficulty) {
                    case 'normal':
                        this.boardSize = 9;
                        this.animalTypes = ['tiger', 'dragon', 'phoenix', 'turtle', 'crane'];
                        break;
                    case 'medium':
                        this.boardSize = 8;
                        this.animalTypes = ['tiger', 'dragon', 'phoenix', 'turtle', 'crane'];
                        break;
                    case 'hard':
                        this.boardSize = 9;
                        this.animalTypes = ['tiger', 'dragon', 'phoenix', 'turtle', 'crane', 'panda'];
                        break;
                    default:
                        this.boardSize = 9;
                        this.animalTypes = ['tiger', 'dragon', 'phoenix', 'turtle', 'crane'];
                }
                
                this.animalSymbols = {
                    'tiger': 'ğŸ¯',
                    'dragon': 'ğŸ‰',
                    'phoenix': 'ğŸ¦…',
                    'turtle': 'ğŸ¢',
                    'crane': 'ğŸ¦¢',
                    'panda': 'ğŸ¼'
                };
            }
            
            init() {
                this.createBoard();
                this.updateScoreDisplay();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
                const hasSavedState = this.loadGameState();
                
                if (hasSavedState) {
                    // æ¢å¤æ£‹ç›˜çŠ¶æ€
                    this.restoreBoard();
                    this.updateNextPiecesDisplay();
                } else {
                    // å¼€å§‹æ–°æ¸¸æˆ
                    this.generateNextPieces();
                    this.placeInitialPieces();
                }
                
                this.bindEvents();
                this.updateSoundControl();
            }
            
            // æ¢å¤æ£‹ç›˜çŠ¶æ€
            restoreBoard() {
                for (let row = 0; row < this.boardSize; row++) {
                    for (let col = 0; col < this.boardSize; col++) {
                        if (this.board[row][col] !== null) {
                            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                            if (cell) {
                                const piece = document.createElement('div');
                                piece.className = 'piece';
                                piece.dataset.type = this.board[row][col];
                                piece.textContent = this.animalSymbols[this.board[row][col]];
                                cell.appendChild(piece);
                            }
                        }
                    }
                }
            }
            
            createBoard() {
                const gameBoard = document.getElementById('gameBoard');
                gameBoard.innerHTML = '';
                
                // è®¾ç½®æ£‹ç›˜å¤§å°ç±»å
                gameBoard.className = `game-board size-${this.boardSize}`;
                
                for (let row = 0; row < this.boardSize; row++) {
                    this.board[row] = [];
                    for (let col = 0; col < this.boardSize; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        gameBoard.appendChild(cell);
                        this.board[row][col] = null;
                    }
                }
            }
            
            generateNextPieces() {
                this.nextPieces = [];
                for (let i = 0; i < 3; i++) {
                    this.nextPieces.push(this.getRandomAnimalType());
                }
                this.updateNextPiecesDisplay();
            }
            
            getRandomAnimalType() {
                return this.animalTypes[Math.floor(Math.random() * this.animalTypes.length)];
            }
            
            updateNextPiecesDisplay() {
                const nextPiecesContainer = document.getElementById('nextPieces');
                const nextPieceElements = nextPiecesContainer.children;
                
                for (let i = 0; i < 3; i++) {
                    const pieceElement = nextPieceElements[i];
                    const animalType = this.nextPieces[i];
                    pieceElement.dataset.type = animalType;
                    pieceElement.textContent = this.animalSymbols[animalType];
                }
            }
            
            placeInitialPieces() {
                // éšæœºæ”¾ç½®3ä¸ªåˆå§‹æ£‹å­
                for (let i = 0; i < 3; i++) {
                    this.placeRandomPiece();
                }
            }
            
            placeRandomPiece() {
                const emptyCells = this.getEmptyCells();
                if (emptyCells.length === 0) return false;
                
                // ç¡®ä¿æœ‰å¯ç”¨çš„æ£‹å­ç±»å‹
                if (this.nextPieces.length === 0) {
                    this.generateNextPieces();
                }
                
                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                const animalType = this.nextPieces.shift();
                
                if (animalType) {
                    this.placePiece(randomCell.row, randomCell.col, animalType);
                    return true;
                }
                
                return false;
            }
            
            async placeThreePieces() {
                // è®°å½•æ–°æŠ•æ”¾æ£‹å­çš„åæ ‡
                const newPieces = [];
                for (let i = 0; i < 3; i++) {
                    const pos = this.placeRandomPieceWithPos();
                    if (pos) newPieces.push(pos);
                    else break;
                }
                this.generateNextPieces();
                // æ£€æŸ¥æ‰€æœ‰æ–°æŠ•æ”¾æ£‹å­çš„æ¶ˆé™¤
                let eliminated = new Set();
                for (const {row, col} of newPieces) {
                    const toEliminate = this.checkElimination(row, col);
                    toEliminate.forEach(pos => eliminated.add(pos));
                }
                if (eliminated.size > 0) {
                    // è½¬ä¸ºæ•°ç»„å¹¶æ¶ˆé™¤
                    this.eliminatePieces(Array.from(eliminated));
                    // æ¶ˆé™¤åä¸å†æŠ•æ”¾æ–°æ£‹å­
                    return;
                }
            }

            // è¿”å›æŠ•æ”¾æ£‹å­çš„åæ ‡
            placeRandomPieceWithPos() {
                const emptyCells = this.getEmptyCells();
                if (emptyCells.length === 0) return null;
                if (this.nextPieces.length === 0) {
                    this.generateNextPieces();
                }
                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                const animalType = this.nextPieces.shift();
                if (animalType) {
                    this.placePiece(randomCell.row, randomCell.col, animalType);
                    return { row: randomCell.row, col: randomCell.col };
                }
                return null;
            }
            
            getEmptyCells() {
                const emptyCells = [];
                for (let row = 0; row < this.boardSize; row++) {
                    for (let col = 0; col < this.boardSize; col++) {
                        if (this.board[row][col] === null) {
                            emptyCells.push({ row, col });
                        }
                    }
                }
                return emptyCells;
            }
            
            placePiece(row, col, animalType) {
                if (this.board[row][col] !== null) return false;
                
                this.board[row][col] = animalType;
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                
                const piece = document.createElement('div');
                piece.className = 'piece';
                piece.dataset.type = animalType;
                piece.textContent = this.animalSymbols[animalType];
                
                cell.appendChild(piece);
                return true;
            }
            
            bindEvents() {
                const gameBoard = document.getElementById('gameBoard');
                
                // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newGameBoard = gameBoard.cloneNode(true);
                gameBoard.parentNode.replaceChild(newGameBoard, gameBoard);
                
                newGameBoard.addEventListener('click', (e) => {
                    if (this.gameOver) return;
                    
                    const cell = e.target.closest('.cell');
                    if (!cell) return;
                    
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    
                    this.handleCellClick(row, col);
                });
            }
            
            updateSoundControl() {
                const soundControl = document.getElementById('soundControl');
                soundControl.textContent = this.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            }
            
            playSound(soundId) {
                // æ¶ˆé™¤éŸ³æ•ˆå§‹ç»ˆæ’­æ”¾
                if (soundId === 'eliminateSound') {
                    const audio = document.getElementById(soundId);
                    if (audio) {
                        audio.currentTime = 0;
                        audio.play().catch(e => {});
                    }
                    return;
                }
                // å…¶å®ƒéŸ³æ•ˆå—é™éŸ³æ§åˆ¶
                if (!this.soundEnabled) return;
                const audio = document.getElementById(soundId);
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => {});
                }
            }
            
            handleCellClick(row, col) {
                if (this.board[row][col] !== null) {
                    // ç‚¹å‡»æœ‰æ£‹å­çš„æ ¼å­
                    this.selectCell(row, col);
                } else if (this.selectedCell) {
                    // ç‚¹å‡»ç©ºæ ¼å­ï¼Œå…ˆæ˜¾ç¤ºè·¯å¾„ï¼Œç„¶åç§»åŠ¨æ£‹å­
                    this.showPathToTarget(row, col);
                    setTimeout(() => {
                        this.movePiece(this.selectedCell.row, this.selectedCell.col, row, col);
                    }, 500); // æ˜¾ç¤ºè·¯å¾„0.5ç§’åç§»åŠ¨
                }
            }
            
            selectCell(row, col) {
                // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
                this.clearSelection();
                
                this.selectedCell = { row, col };
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                cell.classList.add('selected');
                
                // æ’­æ”¾é€‰æ‹©éŸ³æ•ˆ
                this.playSound('selectSound');
                
                // æ˜¾ç¤ºå¯ç§»åŠ¨çš„è·¯å¾„
                this.showValidMoves(row, col);
            }
            
            clearSelection() {
                if (this.selectedCell) {
                    const cell = document.querySelector(`[data-row="${this.selectedCell.row}"][data-col="${this.selectedCell.col}"]`);
                    cell.classList.remove('selected');
                }
                
                // æ¸…é™¤æ‰€æœ‰è·¯å¾„æ˜¾ç¤º
                document.querySelectorAll('.cell.path').forEach(cell => {
                    cell.classList.remove('path');
                });
                
                this.selectedCell = null;
                this.validMoves = null;
            }
            
            showValidMoves(startRow, startCol) {
                const validMoves = this.findValidMoves(startRow, startCol);
                
                // ä¸æ˜¾ç¤ºä»»ä½•æç¤ºï¼Œåªè®°å½•å¯ç§»åŠ¨ä½ç½®
                this.validMoves = validMoves;
                
                // è°ƒè¯•ä¿¡æ¯
                console.log(`æ‰¾åˆ° ${validMoves.length} ä¸ªå¯ç§»åŠ¨ä½ç½®`);
            }
            
            showPathToTarget(targetRow, targetCol) {
                // æ¸…é™¤ä¹‹å‰çš„è·¯å¾„æ˜¾ç¤º
                document.querySelectorAll('.cell.path').forEach(cell => {
                    cell.classList.remove('path');
                });
                
                if (!this.selectedCell || !this.validMoves) return;
                
                const targetMove = this.validMoves.find(move => move.row === targetRow && move.col === targetCol);
                
                if (targetMove && targetMove.path.length > 0) {
                    // æ˜¾ç¤ºæœ€çŸ­è·¯å¾„
                    targetMove.path.forEach(pathStep => {
                        const pathCell = document.querySelector(`[data-row="${pathStep.row}"][data-col="${pathStep.col}"]`);
                        if (pathCell) {
                            pathCell.classList.add('path');
                        }
                    });
                    
                    console.log(`æ˜¾ç¤ºåˆ° (${targetRow}, ${targetCol}) çš„è·¯å¾„:`, targetMove.path);
                } else {
                    console.log(`æ— æ³•ç§»åŠ¨åˆ° (${targetRow}, ${targetCol})`);
                }
            }
            
            findValidMoves(startRow, startCol) {
                const validMoves = [];
                const visited = new Set();
                const queue = [{ row: startRow, col: startCol, path: [] }];
                
                // æ ‡è®°èµ·ç‚¹ä¸ºå·²è®¿é—®
                visited.add(`${startRow},${startCol}`);
                
                while (queue.length > 0) {
                    const current = queue.shift();
                    
                    // æ£€æŸ¥å››ä¸ªæ–¹å‘
                    const directions = [
                        { row: -1, col: 0 }, // ä¸Š
                        { row: 1, col: 0 },  // ä¸‹
                        { row: 0, col: -1 }, // å·¦
                        { row: 0, col: 1 }   // å³
                    ];
                    
                    directions.forEach(dir => {
                        const newRow = current.row + dir.row;
                        const newCol = current.col + dir.col;
                        const newKey = `${newRow},${newCol}`;
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆä½ç½®ä¸”æœªè®¿é—®è¿‡ä¸”ä¸ºç©º
                        if (this.isValidPosition(newRow, newCol) && 
                            !visited.has(newKey) && 
                            this.board[newRow][newCol] === null) {
                            
                            visited.add(newKey);
                            const newPath = [...current.path, { row: newRow, col: newCol }];
                            
                            // æ·»åŠ åˆ°æœ‰æ•ˆç§»åŠ¨åˆ—è¡¨
                            validMoves.push({ row: newRow, col: newCol, path: newPath });
                            
                            // ç»§ç»­ä»è¿™ä¸ªä½ç½®æœç´¢
                            queue.push({ row: newRow, col: newCol, path: newPath });
                        }
                    });
                }
                
                // è°ƒè¯•ä¿¡æ¯
                console.log(`ä» (${startRow}, ${startCol}) æ‰¾åˆ° ${validMoves.length} ä¸ªå¯ç§»åŠ¨ä½ç½®`);
                validMoves.forEach(move => {
                    console.log(`  å¯ç§»åŠ¨åˆ° (${move.row}, ${move.col})ï¼Œè·¯å¾„é•¿åº¦: ${move.path.length}`);
                });
                
                return validMoves;
            }
            
            isValidPosition(row, col) {
                return row >= 0 && row < this.boardSize && col >= 0 && col < this.boardSize;
            }
            
            async movePiece(fromRow, fromCol, toRow, toCol) {
                const validMoves = this.findValidMoves(fromRow, fromCol);
                const targetMove = validMoves.find(move => move.row === toRow && move.col === toCol);
                if (!targetMove) {
                    this.clearSelection();
                    return false;
                }
                // æ’­æ”¾ç§»åŠ¨éŸ³æ•ˆ
                this.playSound('moveSound');
                // è·å–è·¯å¾„
                const path = targetMove.path;
                // ç§»åŠ¨å‰æ¸…é™¤æ©™è‰²è·¯å¾„æç¤º
                document.querySelectorAll('.cell.path').forEach(cell => cell.classList.remove('path'));
                // åŠ¨ç”»é€æ­¥ç§»åŠ¨
                let curRow = fromRow, curCol = fromCol;
                const animalType = this.board[fromRow][fromCol];
                const piece = document.querySelector(`[data-row="${fromRow}"][data-col="${fromCol}"] .piece`);
                for (const step of path) {
                    // æ¸…é™¤å½“å‰ä½ç½®
                    this.board[curRow][curCol] = null;
                    const fromCell = document.querySelector(`[data-row="${curRow}"][data-col="${curCol}"]`);
                    if (fromCell && fromCell.contains(piece)) fromCell.removeChild(piece);
                    // ç§»åŠ¨åˆ°ä¸‹ä¸€æ­¥
                    this.board[step.row][step.col] = animalType;
                    const toCell = document.querySelector(`[data-row="${step.row}"][data-col="${step.col}"]`);
                    toCell.appendChild(piece);
                    curRow = step.row;
                    curCol = step.col;
                    // ç­‰å¾…åŠ¨ç”»
                    await new Promise(res => setTimeout(res, 30));
                }
                // æœ€ç»ˆä½ç½®
                this.clearSelection();
                // æ£€æŸ¥æ¶ˆé™¤
                const eliminatedPieces = this.checkElimination(toRow, toCol);
                if (eliminatedPieces.length > 0) {
                    this.eliminatePieces(eliminatedPieces);
                    // æœ‰æ¶ˆé™¤æ—¶ä¸æŠ•æ”¾æ–°æ£‹å­
                } else {
                    // æ²¡æœ‰æ¶ˆé™¤æ—¶æŠ•æ”¾3ä¸ªæ–°æ£‹å­
                    await this.placeThreePieces();
                }
                // ä¿å­˜æ¸¸æˆçŠ¶æ€
                this.saveGameState();
                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                if (this.isGameOver()) {
                    this.endGame();
                }
                return true;
            }
            
            checkElimination(row, col) {
                const animalType = this.board[row][col];
                const eliminatedPieces = new Set();
                // å››ä¸ªæ–¹å‘ï¼šæ¨ªã€ç«–ã€ä¸»å¯¹è§’çº¿ã€å‰¯å¯¹è§’çº¿
                const directions = [
                    { dr: 0, dc: 1 },   // æ¨ªå‘
                    { dr: 1, dc: 0 },   // çºµå‘
                    { dr: 1, dc: 1 },   // ä¸»å¯¹è§’çº¿
                    { dr: 1, dc: -1 }   // å‰¯å¯¹è§’çº¿
                ];
                for (const {dr, dc} of directions) {
                    const line = [{ row, col }];
                    // å‘æ­£æ–¹å‘æ‰©å±•
                    let r = row + dr, c = col + dc;
                    while (this.isValidPosition(r, c) && this.board[r][c] === animalType) {
                        line.push({ row: r, col: c });
                        r += dr;
                        c += dc;
                    }
                    // å‘åæ–¹å‘æ‰©å±•
                    r = row - dr; c = col - dc;
                    while (this.isValidPosition(r, c) && this.board[r][c] === animalType) {
                        line.unshift({ row: r, col: c });
                        r -= dr;
                        c -= dc;
                    }
                    // æ»¡è¶³5è¿åŠä»¥ä¸Š
                    if (line.length >= 5) {
                        line.forEach(pos => eliminatedPieces.add(`${pos.row},${pos.col}`));
                    }
                }
                return Array.from(eliminatedPieces);
            }
            
            checkLine(startRow, startCol, deltaRow, deltaCol, animalType, eliminatedPieces) {
                let count = 0;
                const line = [];
                
                // å‘å‰æ£€æŸ¥
                for (let i = 0; i < this.boardSize; i++) {
                    const row = startRow + i * deltaRow;
                    const col = startCol + i * deltaCol;
                    
                    if (!this.isValidPosition(row, col)) break;
                    
                    if (this.board[row][col] === animalType) {
                        count++;
                        line.push({ row, col });
                    } else {
                        break;
                    }
                }
                
                // å‘åæ£€æŸ¥
                for (let i = 1; i < this.boardSize; i++) {
                    const row = startRow - i * deltaRow;
                    const col = startCol - i * deltaCol;
                    
                    if (!this.isValidPosition(row, col)) break;
                    
                    if (this.board[row][col] === animalType) {
                        count++;
                        line.push({ row, col });
                    } else {
                        break;
                    }
                }
                
                if (count >= 5) {
                    line.forEach(pos => eliminatedPieces.add(`${pos.row},${pos.col}`));
                }
            }
            
            checkDiagonal(row, col, animalType, eliminatedPieces) {
                // æ£€æŸ¥ä¸»å¯¹è§’çº¿
                this.checkLine(row, col, -1, -1, animalType, eliminatedPieces);
                this.checkLine(row, col, 1, 1, animalType, eliminatedPieces);
                
                // æ£€æŸ¥å‰¯å¯¹è§’çº¿
                this.checkLine(row, col, -1, 1, animalType, eliminatedPieces);
                this.checkLine(row, col, 1, -1, animalType, eliminatedPieces);
            }
            
            eliminatePieces(eliminatedPieces) {
                const score = eliminatedPieces.length * 10;
                this.currentScore += score;
                this.updateScoreDisplay();
                
                // æ’­æ”¾æ¶ˆé™¤éŸ³æ•ˆ
                this.playSound('eliminateSound');
                
                eliminatedPieces.forEach(posStr => {
                    const [row, col] = posStr.split(',').map(Number);
                    this.board[row][col] = null;
                    
                    const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                    const piece = cell.querySelector('.piece');
                    
                    if (piece) {
                        piece.classList.add('eliminating');
                        setTimeout(() => {
                            if (piece.parentNode) {
                                piece.parentNode.removeChild(piece);
                            }
                        }, 500);
                    }
                });
                
                // ä¿å­˜æ¸¸æˆçŠ¶æ€
                this.saveGameState();
            }
            
            isGameOver() {
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç©ºæ ¼å­
                const emptyCells = this.getEmptyCells();
                if (emptyCells.length === 0) return true;
                
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¯ç§»åŠ¨çš„æ£‹å­
                for (let row = 0; row < this.boardSize; row++) {
                    for (let col = 0; col < this.boardSize; col++) {
                        if (this.board[row][col] !== null) {
                            const validMoves = this.findValidMoves(row, col);
                            if (validMoves.length > 0) {
                                return false;
                            }
                        }
                    }
                }
                
                return true;
            }
            
            endGame() {
                this.gameOver = true;
                
                // æ›´æ–°æœ€é«˜åˆ†
                if (this.currentScore > this.bestScore) {
                    this.bestScore = this.currentScore;
                    localStorage.setItem('bestScore', this.bestScore);
                    this.updateScoreDisplay();
                }
                
                // æ¸…é™¤æ¸¸æˆçŠ¶æ€
                this.clearGameState();
                
                // æ˜¾ç¤ºæ¸¸æˆç»“æŸæ¨¡æ€æ¡†
                const modal = document.getElementById('gameOverModal');
                const finalScore = document.getElementById('finalScore');
                finalScore.textContent = this.currentScore;
                modal.style.display = 'flex';
            }
            
            updateScoreDisplay() {
                document.getElementById('currentScore').textContent = this.currentScore;
                document.getElementById('bestScore').textContent = this.bestScore;
                
                // æ›´æ–°ç­‰çº§æ˜¾ç¤º
                const newLevel = this.calculateLevel(this.currentScore);
                if (newLevel !== this.currentLevel) {
                    this.currentLevel = newLevel;
                    this.checkLevelUp();
                }
                
                // æ˜¾ç¤ºå½“å‰ç­‰çº§
                this.updateLevelDisplay();
            }
            
            // æ£€æŸ¥ç­‰çº§æå‡
            checkLevelUp() {
                const levelOrder = ['é’é“œ', 'é»„é‡‘', 'é“‚é‡‘', 'é’»çŸ³', 'æ˜Ÿè€€', 'ç‹è€…'];
                const currentIndex = levelOrder.indexOf(this.currentLevel);
                const playerIndex = levelOrder.indexOf(this.playerLevel);
                
                if (currentIndex > playerIndex) {
                    // ç­‰çº§æå‡
                    this.playerLevel = this.currentLevel;
                    localStorage.setItem('playerLevel', this.playerLevel);
                    this.showLevelUpEffect();
                }
            }
            
            // æ˜¾ç¤ºç­‰çº§æå‡æ•ˆæœ
            showLevelUpEffect() {
                // åˆ›å»ºç¤¼èŠ±æ•ˆæœ
                this.createFireworks();
                
                // æ˜¾ç¤ºç­‰çº§æå‡æç¤º
                setTimeout(() => {
                    alert(`ğŸ‰ æ­å–œæ‚¨å‡çº§åˆ° ${this.playerLevel} ç­‰çº§ï¼`);
                }, 1000);
            }
            
            // åˆ›å»ºç¤¼èŠ±æ•ˆæœ
            createFireworks() {
                const container = document.querySelector('.game-container');
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        this.createFirework(container);
                    }, i * 100);
                }
            }
            
            // åˆ›å»ºå•ä¸ªç¤¼èŠ±
            createFirework(container) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.left = Math.random() * 100 + '%';
                firework.style.top = Math.random() * 100 + '%';
                firework.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(firework);
                
                setTimeout(() => {
                    if (firework.parentNode) {
                        firework.parentNode.removeChild(firework);
                    }
                }, 2000);
            }
            
            // æ›´æ–°ç­‰çº§æ˜¾ç¤º
            updateLevelDisplay() {
                const levelDisplay = document.getElementById('levelDisplay');
                if (levelDisplay) {
                    levelDisplay.textContent = this.currentLevel;
                }
            }
            
            restartGame() {
                this.board = [];
                this.currentScore = 0;
                this.nextPieces = [];
                this.selectedCell = null;
                this.validMoves = null;
                this.gameOver = false;
                
                // æ¸…é™¤æ¸¸æˆçŠ¶æ€
                this.clearGameState();
                
                // éšè—æ¨¡æ€æ¡†
                document.getElementById('gameOverModal').style.display = 'none';
                
                this.init();
            }
            
            // è‡ªæˆ‘æµ‹è¯•å‡½æ•°
            selfTest() {
                console.log('=== å¼€å§‹è‡ªæˆ‘æµ‹è¯• ===');
                
                // æµ‹è¯•1: æ£€æŸ¥è·¯å¾„ç®—æ³•
                this.testPathAlgorithm();
                
                // æµ‹è¯•2: æ£€æŸ¥æ£‹å­æ˜¾ç¤º
                this.testPieceDisplay();
                
                // æµ‹è¯•3: æ£€æŸ¥ç§»åŠ¨é€»è¾‘
                this.testMoveLogic();
                
                console.log('=== è‡ªæˆ‘æµ‹è¯•å®Œæˆ ===');
            }
            
            testPathAlgorithm() {
                console.log('æµ‹è¯•è·¯å¾„ç®—æ³•...');
                
                // æ¸…ç©ºæ£‹ç›˜è¿›è¡Œæµ‹è¯•
                this.board = [];
                for (let row = 0; row < this.boardSize; row++) {
                    this.board[row] = [];
                    for (let col = 0; col < this.boardSize; col++) {
                        this.board[row][col] = null;
                    }
                }
                
                // åœ¨ä¸­å¿ƒæ”¾ç½®ä¸€ä¸ªæ£‹å­
                this.board[4][4] = 'tiger';
                
                // æµ‹è¯•è·¯å¾„æŸ¥æ‰¾
                const moves = this.findValidMoves(4, 4);
                console.log(`ä»ä¸­å¿ƒä½ç½®æ‰¾åˆ° ${moves.length} ä¸ªå¯ç§»åŠ¨ä½ç½®`);
                
                // éªŒè¯æ˜¯å¦åŒ…å«è¿œè·ç¦»ä½ç½®
                const hasFarMove = moves.some(move => {
                    const distance = Math.abs(move.row - 4) + Math.abs(move.col - 4);
                    return distance > 1;
                });
                
                if (hasFarMove) {
                    console.log('âœ… è·¯å¾„ç®—æ³•æ­£ç¡®ï¼šæ”¯æŒå¤šæ ¼ç§»åŠ¨');
                } else {
                    console.log('âŒ è·¯å¾„ç®—æ³•é”™è¯¯ï¼šåªèƒ½ç§»åŠ¨ä¸€æ ¼');
                }
                
                // æ¢å¤æ£‹ç›˜
                this.init();
            }
            
            testPieceDisplay() {
                console.log('æµ‹è¯•æ£‹å­æ˜¾ç¤º...');
                
                // æ£€æŸ¥æ£‹å­æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
                const pieces = document.querySelectorAll('.piece');
                let displayCorrect = true;
                
                pieces.forEach(piece => {
                    const type = piece.dataset.type;
                    const symbol = piece.textContent;
                    
                    if (!type || !symbol || symbol !== this.animalSymbols[type]) {
                        displayCorrect = false;
                        console.log(`âŒ æ£‹å­æ˜¾ç¤ºé”™è¯¯: type=${type}, symbol=${symbol}`);
                    }
                });
                
                if (displayCorrect) {
                    console.log('âœ… æ£‹å­æ˜¾ç¤ºæ­£ç¡®');
                } else {
                    console.log('âŒ æ£‹å­æ˜¾ç¤ºæœ‰é—®é¢˜');
                }
            }
            
            testMoveLogic() {
                console.log('æµ‹è¯•ç§»åŠ¨é€»è¾‘...');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ£‹å­
                if (this.selectedCell) {
                    console.log(`âœ… æœ‰é€‰ä¸­çš„æ£‹å­: (${this.selectedCell.row}, ${this.selectedCell.col})`);
                } else {
                    console.log('â„¹ï¸ å½“å‰æ²¡æœ‰é€‰ä¸­çš„æ£‹å­');
                }
                
                // æ£€æŸ¥å¯ç§»åŠ¨ä½ç½®
                if (this.validMoves) {
                    console.log(`âœ… æœ‰ ${this.validMoves.length} ä¸ªå¯ç§»åŠ¨ä½ç½®`);
                } else {
                    console.log('â„¹ï¸ å½“å‰æ²¡æœ‰å¯ç§»åŠ¨ä½ç½®');
                }
            }
        }

        // å¯åŠ¨æ¸¸æˆ
        let game = null;
        let bgmPlaying = false;

        function updateBgmIcon() {
            const bgmControl = document.getElementById('bgmControl');
            if (bgmControl) bgmControl.textContent = bgmPlaying ? 'ğŸ”Š' : 'ğŸ”ˆ';
        }

        function changeDifficulty() {
            const difficultySelect = document.getElementById('difficultySelect');
            const difficulty = difficultySelect.value;
            
            if (game) {
                // é‡æ–°åˆ›å»ºæ¸¸æˆå®ä¾‹
                game = new AnimalMatchGame(difficulty);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const bgm = document.getElementById('bgm');
            const bgmControl = document.getElementById('bgmControl');
            
            // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
            if (bgmControl) {
                bgmControl.onclick = () => {
                    if (bgm.paused) {
                        bgm.play();
                        bgmPlaying = true;
                    } else {
                        bgm.pause();
                        bgmPlaying = false;
                    }
                    updateBgmIcon();
                };
            }
            
            // é¡µé¢åŠ è½½æ—¶å°è¯•è‡ªåŠ¨æ’­æ”¾
            bgm.play().then(() => {
                bgmPlaying = true;
                updateBgmIcon();
            }).catch(() => {
                // å¦‚æœè¢«æ‹¦æˆªï¼Œç­‰å¾…ç”¨æˆ·é¦–æ¬¡ç‚¹å‡»
                document.body.addEventListener('click', () => {
                    if (!bgmPlaying) {
                        bgm.play().then(()=>{bgmPlaying=true;updateBgmIcon();}).catch(()=>{});
                    }
                }, { once: true });
            });
            updateBgmIcon();
            
            // éš¾åº¦é€‰æ‹©ä¸‹æ‹‰æ¡†äº‹ä»¶
            document.getElementById('difficultySelect').addEventListener('change', changeDifficulty);
            
            // é‡æ–°å¼€å§‹æŒ‰é’®äº‹ä»¶
            document.getElementById('restartBtn').addEventListener('click', () => {
                if (game) {
                    game.restartGame();
                }
            });
            
            // æ¨¡æ€æ¡†é‡æ–°å¼€å§‹æŒ‰é’®äº‹ä»¶
            document.getElementById('modalRestartBtn').addEventListener('click', () => {
                if (game) {
                    game.restartGame();
                }
            });
            
            // åˆå§‹åŒ–æ¸¸æˆ
            game = new AnimalMatchGame('normal');
        }); 
    </script>
</body>
</html> 
